// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountType {
  b2c
  b2b
  admin
}

enum BusinessType {
  Restaurant
  Hotel
  RetailStore
  Office
  Cafe
  Other
}

enum BusinessStatus {
  pending
  approved
  rejected
  suspended
}

enum OrderStatus {
  placed
  confirmed
  processing
  dispatched
  delivered
  cancelled
}

enum PaymentMethod {
  cod
  credit
}

enum PaymentStatus {
  pending
  paid
  overdue
}

model User {
  id            String      @id @default(uuid())
  fullName      String      @map("full_name") @db.VarChar(100)
  email         String      @unique @db.VarChar(100)
  mobile        String      @unique @db.VarChar(10)
  passwordHash  String      @map("password_hash") @db.VarChar(255)
  accountType   AccountType @map("account_type") @default(b2c)
  emailVerified Boolean     @map("email_verified") @default(false)
  mobileVerified Boolean    @map("mobile_verified") @default(false)
  status        String      @default("active") @db.VarChar(20)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  b2bBusiness   B2BBusiness?
  orders        Order[]
  cart          Cart?

  @@map("users")
}

model B2BBusiness {
  id                String        @id @default(uuid())
  userId            String        @unique @map("user_id")
  businessName      String        @map("business_name") @db.VarChar(200)
  businessType      BusinessType  @map("business_type")
  gstNumber         String        @unique @map("gst_number") @db.VarChar(15)
  panNumber         String        @map("pan_number") @db.VarChar(10)
  registrationNumber String?      @map("registration_number") @db.VarChar(50)
  
  // JSON fields for complex data
  contactPerson     Json          @map("contact_person")
  businessAddress   Json          @map("business_address")
  documents         Json
  
  accountStatus     BusinessStatus @map("account_status") @default(pending)
  creditLimit       Decimal       @map("credit_limit") @default(0) @db.Decimal(12, 2)
  creditPeriodDays  Int           @map("credit_period_days") @default(30)
  availableCredit   Decimal       @map("available_credit") @default(0) @db.Decimal(12, 2)
  usedCredit        Decimal       @map("used_credit") @default(0) @db.Decimal(12, 2)
  
  approvalDate      DateTime?     @map("approval_date")
  approvedBy        String?       @map("approved_by")
  rejectionReason   String?       @map("rejection_reason") @db.Text
  
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveryAddresses B2BDeliveryAddress[]
  orders            Order[]

  @@map("b2b_businesses")
}

model B2BDeliveryAddress {
  id              String        @id @default(uuid())
  businessId      String        @map("business_id")
  label           String        @db.VarChar(100)
  addressLine1    String        @map("address_line1") @db.VarChar(200)
  addressLine2    String?       @map("address_line2") @db.VarChar(200)
  city            String        @db.VarChar(100)
  state           String        @db.VarChar(100)
  pincode         String        @db.VarChar(6)
  contactPerson   String        @map("contact_person") @db.VarChar(100)
  contactMobile   String        @map("contact_mobile") @db.VarChar(10)
  isDefault       Boolean       @map("is_default") @default(false)
  isActive        Boolean       @map("is_active") @default(true)
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations
  business        B2BBusiness   @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@map("b2b_delivery_addresses")
}

model Category {
  id          String        @id @default(uuid())
  name        String        @unique @db.VarChar(100)
  description String?       @db.Text
  imageUrl    String?       @map("image_url")
  isActive    Boolean       @map("is_active") @default(true)
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  // Relations
  subcategories Subcategory[]
  products      Product[]

  @@map("categories")
}

model Subcategory {
  id          String      @id @default(uuid())
  categoryId  String      @map("category_id")
  name        String      @db.VarChar(100)
  description String?     @db.Text
  isActive    Boolean     @map("is_active") @default(true)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  category    Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products    Product[]

  @@unique([categoryId, name])
  @@map("subcategories")
}

model Product {
  id                String      @id @default(uuid())
  sku               String      @unique @db.VarChar(50)
  name              String      @db.VarChar(100)
  categoryId        String      @map("category_id")
  subcategoryId     String      @map("subcategory_id")
  brand             String?     @db.VarChar(50)
  description       String      @db.Text
  unit              String      @db.VarChar(20)
  quantityPerUnit   Decimal     @map("quantity_per_unit") @db.Decimal(10, 2)
  images            Json?       // Array of image URLs
  
  // B2C Pricing
  b2cMrp            Decimal     @map("b2c_mrp") @db.Decimal(10, 2)
  b2cSellingPrice   Decimal     @map("b2c_selling_price") @db.Decimal(10, 2)
  b2cMinQuantity    Int         @map("b2c_min_quantity") @default(1)
  b2cMaxQuantity    Int         @map("b2c_max_quantity") @default(10)
  
  // B2B Pricing
  b2bBasePrice      Decimal     @map("b2b_base_price") @db.Decimal(10, 2)
  b2bMinOrderQty    Int         @map("b2b_min_order_qty")
  b2bMaxOrderQty    Int?        @map("b2b_max_order_qty")
  b2bBulkTiers      Json?       @map("b2b_bulk_tiers") // Array of pricing tiers
  
  // Inventory
  totalStock         Int         @map("total_stock") @default(0)
  b2cReservedStock   Int         @map("b2c_reserved_stock") @default(0)
  b2bReservedStock   Int         @map("b2b_reserved_stock") @default(0)
  
  isVegetarian       Boolean?    @map("is_vegetarian") @default(true)
  expiryDate         DateTime?   @map("expiry_date") @db.Date
  status             String      @default("active") @db.VarChar(20)
  isDeleted          Boolean     @map("is_deleted") @default(false)
  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  // Relations
  category           Category    @relation(fields: [categoryId], references: [id])
  subcategory        Subcategory @relation(fields: [subcategoryId], references: [id])
  cartItems          CartItem[]
  orderItems         OrderItem[]

  @@map("products")
}

model Cart {
  id          String      @id @default(uuid())
  userId      String      @unique @map("user_id")
  accountType AccountType @map("account_type")
  businessId  String?     @map("business_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  expiresAt  DateTime?   @map("expires_at")

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items       CartItem[]

  @@map("cart")
}

model CartItem {
  id          String   @id @default(uuid())
  cartId      String   @map("cart_id")
  productId   String   @map("product_id")
  quantity    Int
  unitPrice   Decimal  @map("unit_price") @db.Decimal(10, 2)
  appliedTier String?  @map("applied_tier") @db.VarChar(50)
  addedAt     DateTime @default(now()) @map("added_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  cart        Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])

  @@unique([cartId, productId])
  @@map("cart_items")
}

model Order {
  id                String        @id @default(uuid())
  orderNumber       String        @unique @map("order_number") @db.VarChar(50)
  userId            String        @map("user_id")
  businessId        String?       @map("business_id")
  orderType         AccountType   @map("order_type")
  poNumber          String?       @map("po_number") @db.VarChar(50)
  orderDate         DateTime      @default(now()) @map("order_date")
  orderStatus       OrderStatus   @map("order_status") @default(placed)
  
  // JSON field for delivery info (single address for B2C, multiple for B2B)
  deliveryInfo      Json          @map("delivery_info")
  
  paymentMethod     PaymentMethod @map("payment_method")
  paymentStatus     PaymentStatus @map("payment_status") @default(pending)
  
  // Pricing
  subtotal          Decimal       @db.Decimal(12, 2)
  gstAmount         Decimal       @map("gst_amount") @default(0) @db.Decimal(12, 2)
  deliveryCharges   Decimal       @map("delivery_charges") @default(0) @db.Decimal(12, 2)
  totalAmount       Decimal       @map("total_amount") @db.Decimal(12, 2)
  
  // B2B Credit Info
  creditUsed        Decimal       @map("credit_used") @default(0) @db.Decimal(12, 2)
  dueDate           DateTime?     @map("due_date") @db.Date
  
  specialInstructions String?     @map("special_instructions") @db.Text
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")

  // Relations
  user              User          @relation(fields: [userId], references: [id])
  business          B2BBusiness?  @relation(fields: [businessId], references: [id])
  items             OrderItem[]

  @@map("orders")
}

model OrderItem {
  id                  String   @id @default(uuid())
  orderId             String   @map("order_id")
  productId           String   @map("product_id")
  productName         String   @map("product_name") @db.VarChar(100)
  sku                 String   @db.VarChar(50)
  quantity            Int
  unitPrice           Decimal  @map("unit_price") @db.Decimal(10, 2)
  appliedTier         String?  @map("applied_tier") @db.VarChar(50)
  itemTotal           Decimal  @map("item_total") @db.Decimal(12, 2)
  deliveryLocationId  String?  @map("delivery_location_id") @db.VarChar(100)
  createdAt           DateTime @default(now()) @map("created_at")

  // Relations
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product             Product  @relation(fields: [productId], references: [id])

  @@map("order_items")
}

